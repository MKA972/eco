<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EcoPath Energy & Gas Dashboard</title>

<!-- Fonts & Libraries -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
/* ========= LIGHT THEME ========= */
:root {
  --bg: #f3f6f5;
  --text-main: #00221c;
  --text-secondary: #44524f;
  --primary: #006e55;
  --primary-light: #00a676;
  --accent-amber: #f79c29;
  --card-bg: #ffffff;
  --border: #d0d8d6;
  --shadow: rgba(0, 0, 0, 0.1);
}

/* ========= DARK THEME ========= */
[data-theme="dark"] {
  --bg: #0e141a;
  --text-main: #f1f3f2;
  --text-secondary: #a9b5b3;
  --primary: #00c48c;
  --primary-light: #00ffb0;
  --accent-amber: #ffb703;
  --card-bg: #121c25;
  --border: #22313b;
  --shadow: rgba(0, 0, 0, 0.6);
}

/* ========= GLOBAL ========= */
*{margin:0;padding:0;box-sizing:border-box;transition:background .3s,color .3s,border .3s;}
body{font-family:"Poppins",sans-serif;background:var(--bg);color:var(--text-main);overflow-x:hidden;line-height:1.6;}

header{
  background:var(--card-bg);position:fixed;top:0;width:100%;padding:1rem 8%;
  display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 10px var(--shadow);z-index:100;
}
.LOGO{font-weight:700;font-size:1.6rem;color:var(--primary);text-decoration:none;}
nav a{color:var(--text-main);text-decoration:none;margin:0 1rem;font-weight:500;}
nav a:hover{color:var(--primary-light);}
select{background:var(--primary);color:#fff;border:none;padding:8px 14px;border-radius:8px;font-weight:600;cursor:pointer;margin-left:.6rem;}

.switch{font-size:17px;position:relative;display:inline-block;width:3.5em;height:2em;margin-left:1rem;}
.switch input{opacity:0;width:0;height:0;}
.slider{--background:#b8b6b6;position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--background);transition:.5s;border-radius:25px;}
.slider:before{position:absolute;content:"";height:1.4em;width:1.4em;border-radius:50%;left:10%;bottom:15%;box-shadow: inset 8px -4px 0px 0px #fff000;background:var(--background);transition:.5s;}
input:checked + .slider{background-color:#1a6249;}
input:checked + .slider:before{transform:translateX(100%);box-shadow: inset 15px -4px 0px 15px #fff000;}

.hero{text-align:center;padding:8rem 1rem 4rem;background:linear-gradient(180deg,var(--bg)0%,var(--card-bg)100%);}
.hero h1{font-size:2.6rem;font-weight:700;color:var(--primary);margin-bottom:1rem;}
.hero p{max-width:700px;margin:auto;color:var(--text-secondary);font-size:1.1rem;}

.dashboard{padding:4rem 8%;}
#chartTitle{text-align:center;font-size:1.9rem;font-weight:600;margin-bottom:2rem;color:var(--text-main);}

.kpi-row{display:flex;flex-wrap:wrap;gap:1.5rem;justify-content:center;margin-bottom:3rem;}
.kpi-card{background:var(--card-bg);border-radius:12px;padding:1.2rem 2rem;min-width:220px;text-align:center;box-shadow:0 6px 14px var(--shadow);}
.kpi-card h4{color:var(--primary-light);margin-bottom:.4rem;}
.kpi-card p{font-size:1.2rem;font-weight:600;color:var(--text-main);}

.card-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:2rem;margin-bottom:2rem;}
.chart-card{background:var(--card-bg);border-radius:14px;box-shadow:0 4px 12px var(--shadow);padding:1.5rem;}
.chart-card h3{color:var(--text-main);margin-bottom:1rem;font-weight:600;}
.chart-card canvas{width:100%;height:300px!important;}
.chart-wide{width:95%;margin:0 auto;margin-top:30px;}

#map{height:70vh;width:90%;margin:3rem auto;border-radius:14px;box-shadow:0 6px 20px var(--shadow);border:2px solid var(--border);}
.map-controls{text-align:center;font-weight:600;margin:1rem;}
.map-controls input[type="radio"]{accent-color:var(--primary-light);}

.eco-footer{background:var(--card-bg);border-top:2px solid var(--border);padding:40px 8%;margin-top:60px;}
.footer-container{display:flex;flex-wrap:wrap;justify-content:space-between;gap:40px;}
.footer-logo{font-size:1.6rem;font-weight:700;color:var(--primary);}
.footer-bottom{text-align:center;margin-top:25px;font-size:.85rem;opacity:.7;}
</style>
</head>

<body>

<header>
  <a href="#" class="LOGO" data-key="logo">EcoPath üå±</a>

  <nav>
    <a href="#charts" data-key="dashboard">Dashboard</a>
    <a href="#map" data-key="map">Map</a>
    <a href="#contact" data-key="contact">Contact</a>
    <a href="./gas.html" data-key="waste">Waste</a>

    <select id="citySelect">
      <option>Seoul</option><option>Busan</option><option>Daegu</option>
      <option>Daejeon</option><option>Gyeonggi</option><option>Gangwon</option><option>Jeju</option>
    </select>

    <select id="langSelect" onchange="setLang(this.value)">
      <option value="en">EN</option>
      <option value="kr">KR</option>
      <option value="uz">UZ</option>
    </select>
  </nav>

  <label class="switch"><input type="checkbox" id="themeSwitch"><span class="slider"></span></label>
</header>


<section class="hero">
  <h1 data-key="energy_title">EcoPath Energy & Gas Dashboard</h1>
  <p data-key="energy_subtitle">Compare city-level energy consumption to drive sustainable policies.</p>
</section>

<section class="dashboard" id="charts">
  <h2 id="chartTitle" data-key="chart_title">Energy Overview (<span id="energyCityLabel">Seoul</span>)</h2>

  <div class="kpi-row">
    <div class="kpi-card"><h4 data-key="total_energy">Total Energy</h4><p id="totalEnergy">Loading...</p></div>
    <div class="kpi-card"><h4 data-key="avg_usage">Average Usage</h4><p id="avgEnergy">Loading...</p></div>
    <div class="kpi-card"><h4 data-key="top_district">Top District</h4><p id="topEnergyDistrict">Loading...</p></div>
  </div>

  <div class="card-grid">
    <div class="chart-card"><h3 data-key="electricity_chart">Electricity Usage (kWh)</h3><canvas id="elecChart"></canvas></div>
    <div class="chart-card"><h3 data-key="gas_chart">Gas Usage (m¬≥)</h3><canvas id="gasChart"></canvas></div>
  </div>

  <div class="chart-card chart-wide">
    <h3 style="text-align:center;" data-key="compare_chart">Energy vs Gas Comparison (Cities)</h3>
    <canvas id="lineCompareChart" style="height:380px!important;"></canvas>
  </div>
</section>

<h2 style="text-align:center;margin-top:60px;" data-key="nation_map">üåç Nationwide Energy Map</h2>
<div class="map-controls">
  <label><input type="radio" name="energy" value="Electricity" checked> <span data-key="electricity">Electricity</span></label>
  <label><input type="radio" name="energy" value="Gas"> <span data-key="gas">Gas</span></label>
</div>
<div id="map"></div>

<div style="text-align:center;margin:30px 0;">
  <button id="downloadCSV" style="background:#f79c29;color:#fff;border:none;padding:10px 18px;border-radius:8px;cursor:pointer;font-weight:600;margin-right:10px;">
    üìä Export CSV
  </button>
  <button id="downloadXLSX" style="background:#006e55;color:#fff;border:none;padding:10px 18px;border-radius:8px;cursor:pointer;font-weight:600;">
    üìò Export Excel
  </button>
</div>


<footer class="eco-footer">
  <div class="footer-container">
    <div class="footer-section">
      <h2 class="footer-logo" data-key="logo">EcoPath üå±</h2>
      <p data-key="footer_tagline">Empowering sustainable cities through smart waste & energy analytics.</p>
    </div>

    <div class="footer-section">
      <h3 data-key="navigation">Navigation</h3>
      <a href="index.html" data-key="home">Home</a>
      <a href="energy.html" data-key="energy">Energy & Gas</a>
      <a href="gas.html" data-key="waste">Waste</a>
      <a href="login.html" data-key="login">Admin Login</a>
    </div>

    <div class="footer-section" id="contact">
      <h3 data-key="contact">Contact</h3>
      <p>üìû +82 10-0000-0000</p>
      <p>‚úâÔ∏è support@ecopath.com</p>
      <p>üåç Seoul, South Korea</p>
    </div>
  </div>
  <p class="footer-bottom" data-key="footer_rights">¬© 2025 EcoPath. All rights reserved.</p>
</footer>

<script>
/******** ‚úÖ TRANSLATIONS (MOVED UP + COMPLETED KEYS) ********/
const translations = {
  en: {
    logo:"EcoPath",
    home:"Home",
    dashboard:"Dashboard",
    map:"Map",
    contact:"Contact",
    waste:"Waste",
    energy:"Energy & Gas",
    login:"Login",
    hero_title:"Reduce. Reuse. and Recycle.",
    hero_text:"EcoPath helps you visualize and reduce waste, energy, and emissions ‚Äî empowering cities and individuals to build a sustainable tomorrow.",
    explore_app:"Explore the App",
    about_title:"What is EcoPath?",
    about_text:"EcoPath is a smart environmental tracking platform we built to help people and governments monitor and reduce their ecological footprint. It combines a mobile app for citizens and a web dashboard for municipalities, tracking waste, energy, gas, and water usage with AI-powered trash recognition, interactive maps, and gamified eco-points ‚Äî making sustainable living data-driven, educational, and rewarding.",
    features_title:"Key Features",
    feature1_title:"Eco Behaviour Tracking",
    feature1_text:"Tracks users‚Äô eco-friendly actions like recycling, energy use, and transport choices. Gives insights and suggestions to help them build sustainable daily habits.",
    feature2_title:"Eco MarketPlace",
    feature2_text:"Lets users redeem eco-points for green products, services, or discounts ‚Äî making eco-friendly living more rewarding and accessible.",
    feature3_title:"Gamified Progress",
    feature3_text:"Encourages users through challenges and quizzes that earn eco-XP, unlocking levels, badges, and achievements along their sustainability journey.",
    mobile_title:"Level Up Your Eco Journey",
    mobile_text:"Track recycling progress, earn achievements, \nand and stay  connected with your city‚Äôs sustainability goals ‚Äî \nand all through the EcoPath mobile app.",
    energy_title:"EcoPath Energy & Gas Dashboard",
    energy_subtitle:"Compare city-level energy consumption to drive sustainable policies.",
    chart_title:"Energy Overview",
    total_energy:"Total Energy",
    avg_usage:"Average Usage",
    top_district:"Top District",
    electricity_chart:"Electricity Usage (kWh)",
    gas_chart:"Gas Usage (m¬≥)",
    compare_chart:"Energy vs Gas Comparison (Cities)",
    nation_map:"üåç Nationwide Energy Map",
    electricity:"Electricity",
    gas:"Gas",
    navigation:"Navigation",
    footer_tagline:"Empowering sustainable cities through smart waste & energy analytics.",
    footer_rights:"¬© 2025 EcoPath. All rights reserved.",
    back_to_top:"Back to top"
  },
  kr: {
    logo:"ÏóêÏΩîÌå®Ïä§",
    home:"Ìôà",
    dashboard:"ÎåÄÏãúÎ≥¥Îìú",
    map:"ÏßÄÎèÑ",
    contact:"Ïó∞ÎùΩÏ≤ò",
    waste:"ÌèêÍ∏∞Î¨º",
    energy:"ÏóêÎÑàÏßÄ & Í∞ÄÏä§",
    login:"Î°úÍ∑∏Ïù∏",
    hero_title:"Ï§ÑÏù¥Í≥†, Ïû¨ÏÇ¨Ïö©ÌïòÍ≥†, Ïû¨ÌôúÏö©ÌïòÏÑ∏Ïöî.",
    hero_text:"ÏóêÏΩîÌå®Ïä§Îäî Ïì∞Î†àÍ∏∞, ÏóêÎÑàÏßÄ, Î∞∞Ï∂úÎüâÏùÑ ÏãúÍ∞ÅÌôîÌïòÍ≥† Ï§ÑÏùº Ïàò ÏûàÎèÑÎ°ù ÎèÑÏôÄÏ£ºÎ©∞, ÎèÑÏãúÏôÄ Í∞úÏù∏Ïù¥ Ìï®Íªò ÏßÄÏÜç Í∞ÄÎä•Ìïú ÎÇ¥ÏùºÏùÑ ÎßåÎì§Ïñ¥Í∞ÄÎèÑÎ°ù Ìï©ÎãàÎã§.",
    explore_app:"Ïï± ÏÇ¥Ìé¥Î≥¥Í∏∞",
    about_title:"ÏóêÏΩîÌå®Ïä§ÎûÄ Î¨¥ÏóáÏù∏Í∞ÄÏöî?",
    about_text:"ÏóêÏΩîÌå®Ïä§Îäî ÏÇ¨ÎûåÎì§Í≥º Ï†ïÎ∂ÄÍ∞Ä ÌôòÍ≤Ω Î∞úÏûêÍµ≠ÏùÑ Î™®ÎãàÌÑ∞ÎßÅÌïòÍ≥† Ï§ÑÏùº Ïàò ÏûàÎèÑÎ°ù ÎèïÎäî Ïä§ÎßàÌä∏ ÌôòÍ≤Ω Ï∂îÏ†Å ÌîåÎû´ÌèºÏûÖÎãàÎã§. ÏãúÎØºÏö© Î™®Î∞îÏùº Ïï±Í≥º ÌñâÏ†ïÏö© Ïõπ ÎåÄÏãúÎ≥¥ÎìúÎ•º Í≤∞Ìï©ÌïòÏó¨ Ïì∞Î†àÍ∏∞, ÏóêÎÑàÏßÄ, Í∞ÄÏä§, Î¨º ÏÇ¨Ïö©ÎüâÏùÑ Ï∂îÏ†ÅÌïòÍ≥†, AI Í∏∞Î∞ò Î∂ÑÎ¶¨ÏàòÍ±∞ Ïù∏Ïãù, Ïù∏ÌÑ∞ÎûôÌã∞Î∏å ÏßÄÎèÑ, Í∑∏Î¶¨Í≥† Í≤åÏù¥ÎØ∏ÌîºÏºÄÏù¥ÏÖòÎêú ÏóêÏΩî Ìè¨Ïù∏Ìä∏Î•º ÌÜµÌï¥ ÏßÄÏÜç Í∞ÄÎä•Ìïú ÏÉùÌôúÏùÑ ÏâΩÍ≥† Ïû¨ÎØ∏ÏûàÍ≤å ÎßåÎì§Ïñ¥Ï§çÎãàÎã§.",
    features_title:"Ï£ºÏöî Í∏∞Îä•",
    feature1_title:"ÏπúÌôòÍ≤Ω ÌñâÎèô Ï∂îÏ†Å",
    feature1_text:"Ïû¨ÌôúÏö©, ÏóêÎÑàÏßÄ ÏÇ¨Ïö©, Ïù¥Îèô ÏàòÎã® Îì± ÏÇ¨Ïö©ÏûêÏùò ÏπúÌôòÍ≤Ω ÌôúÎèôÏùÑ Ï∂îÏ†ÅÌïòÍ≥†, ÏùºÏÉÅ ÏÜçÏóêÏÑú Îçî ÏßÄÏÜç Í∞ÄÎä•Ìïú ÏäµÍ¥ÄÏùÑ ÌòïÏÑ±Ìï† Ïàò ÏûàÎèÑÎ°ù Ïù∏ÏÇ¨Ïù¥Ìä∏ÏôÄ Ï†úÏïàÏùÑ Ï†úÍ≥µÌï©ÎãàÎã§.",
    feature2_title:"ÏóêÏΩî ÎßàÏºìÌîåÎ†àÏù¥Ïä§",
    feature2_text:"ÏÇ¨Ïö©ÏûêÎäî ÏóêÏΩî Ìè¨Ïù∏Ìä∏Î•º ÏÇ¨Ïö©ÌïòÏó¨ ÏπúÌôòÍ≤Ω Ï†úÌíà, ÏÑúÎπÑÏä§, ÎòêÎäî Ìï†Ïù∏ ÌòúÌÉùÏùÑ ÍµêÌôòÌï† Ïàò ÏûàÏäµÎãàÎã§. ÏπúÌôòÍ≤Ω ÏÉùÌôúÏùÑ Î≥¥Îã§ Î≥¥ÏÉÅÏ†ÅÏù¥Í≥† Ïã§Ïö©Ï†ÅÏúºÎ°ú ÎßåÎì§Ïñ¥Ï§çÎãàÎã§.",
    feature3_title:"Í≤åÏù¥ÎØ∏ÌîºÏºÄÏù¥ÏÖòÎêú ÏÑ±Ïû•",
    feature3_text:"ÏÇ¨Ïö©ÏûêÎäî ÌÄ¥Ï¶àÎÇò Ï±åÎ¶∞ÏßÄÎ•º ÌÜµÌï¥ ÏóêÏΩî-XPÎ•º ÏñªÍ≥†, Î†àÎ≤®Í≥º Î∞∞ÏßÄÎ•º Ïû†Í∏à Ìï¥Ï†úÌïòÎ©¥ÏÑú ÏßÄÏÜç Í∞ÄÎä•Ìïú Ïó¨Ï†ïÏùÑ Ï¶êÍ≤ÅÍ≤å Ïù¥Ïñ¥Í∞à Ïàò ÏûàÏäµÎãàÎã§.",
    mobile_title:"ÎãπÏã†Ïùò ÏóêÏΩî Ïó¨Ï†ïÏùÑ ÏóÖÍ∑∏Î†àÏù¥ÎìúÌïòÏÑ∏Ïöî",
    mobile_text:"Ïû¨ÌôúÏö© ÏßÑÌñâ ÏÉÅÌô©ÏùÑ Ï∂îÏ†ÅÌïòÍ≥†, ÏóÖÏ†ÅÏùÑ Îã¨ÏÑ±ÌïòÎ©∞,\nÎèÑÏãúÏùò ÏßÄÏÜç Í∞ÄÎä•ÏÑ± Î™©ÌëúÏôÄ Ïó∞Í≤∞ÎêòÏñ¥ Î≥¥ÏÑ∏Ïöî ‚Äî\nÎ™®Îì† Í≤ÉÏù¥ ÏóêÏΩîÌå®Ïä§ Î™®Î∞îÏùº Ïï± ÌïòÎÇòÎ°ú Í∞ÄÎä•Ìï©ÎãàÎã§.",
    energy_title:"ÏóêÏΩîÌå®Ïä§ ÏóêÎÑàÏßÄ & Í∞ÄÏä§ ÎåÄÏãúÎ≥¥Îìú",
    energy_subtitle:"ÎèÑÏãúÎ≥Ñ ÏóêÎÑàÏßÄ ÏÜåÎπÑÎ•º ÎπÑÍµêÌïòÏó¨ ÏßÄÏÜç Í∞ÄÎä•Ìïú Ï†ïÏ±ÖÏùÑ ÏÑ∏Ïö∞ÏÑ∏Ïöî.",
    chart_title:"ÏóêÎÑàÏßÄ Í∞úÏöî",
    total_energy:"Ï¥ù ÏóêÎÑàÏßÄ",
    avg_usage:"ÌèâÍ∑† ÏÇ¨Ïö©Îüâ",
    top_district:"ÏÉÅÏúÑ Íµ¨/Íµ∞",
    electricity_chart:"Ï†ÑÍ∏∞ ÏÇ¨Ïö©Îüâ (kWh)",
    gas_chart:"Í∞ÄÏä§ ÏÇ¨Ïö©Îüâ (m¬≥)",
    compare_chart:"ÏóêÎÑàÏßÄ vs Í∞ÄÏä§ ÎπÑÍµê (ÎèÑÏãú)",
    nation_map:"üåç Ï†ÑÍµ≠ ÏóêÎÑàÏßÄ ÏßÄÎèÑ",
    electricity:"Ï†ÑÍ∏∞",
    gas:"Í∞ÄÏä§",
    navigation:"ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò",
    footer_tagline:"Ïä§ÎßàÌä∏ ÌèêÍ∏∞Î¨º Î∞è ÏóêÎÑàÏßÄ Î∂ÑÏÑùÏùÑ ÌÜµÌïú ÏßÄÏÜç Í∞ÄÎä•Ìïú ÎèÑÏãú Ï°∞ÏÑ±.",
    footer_rights:"¬© 2025 ÏóêÏΩîÌå®Ïä§ ‚Äî Î™®Îì† Í∂åÎ¶¨ Î≥¥Ïú†",
    back_to_top:"Îß® ÏúÑÎ°ú"
  },
  uz: {
    logo:"EcoPath",
    home:"Bosh sahifa",
    dashboard:"Dashboard",
    map:"Xarita",
    contact:"Aloqa",
    waste:"Chiqindilar",
    energy:"Energiya & Gaz",
    login:"Kirish",
    hero_title:"Kamroq ishlat. Qayta foydalangan. Qayta ishlagan.",
    hero_text:"EcoPath chiqindi, energiya va emissiyalarni vizuallashtirib, shaharlar va fuqarolarga barqaror kelajak yaratishda yordam beradi.",
    explore_app:"Ilovani ko‚Äòrish",
    about_title:"EcoPath nima?",
    about_text:"EcoPath ‚Äì odamlar va hukumatlarga ekologik izini kuzatish va kamaytirishda yordam beradigan aqlli platforma. Fuqarolar uchun mobil ilova va hokimiyatlar uchun veb-panel orqali chiqindi, energiya, gaz va suv sarfini kuzatadi; AI asosidagi chiqindi aniqlash, interaktiv xaritalar va gamifikatsiya qilingan eko-ball yordamida barqaror hayotni oson va qiziqarli qiladi.",
    features_title:"Asosiy imkoniyatlar",
    feature1_title:"Ekologik odatlarni kuzatish",
    feature1_text:"Qayta ishlash, energiya sarfi va transport tanlovi kabi xatti-harakatlarni kuzatadi hamda kundalik barqaror odatlar uchun tavsiyalar beradi.",
    feature2_title:"Eko-bozor",
    feature2_text:"To‚Äòplangan eko-ballarni yashil mahsulotlar, xizmatlar yoki chegirmalarga almashtirish mumkin.",
    feature3_title:"Gamifikatsiya qilingan yutuqlar",
    feature3_text:"Testlar va chaqiriqlar orqali eko-XP yig‚Äòing, darajalar va nishonlarni oching.",
    mobile_title:"Eko-sayohatingizni rivojlantiring",
    mobile_text:"Qayta ishlashni kuzating, yutuqlarga erishing,\nva shahringizning barqarorlik maqsadlari bilan bog‚Äòlaning ‚Äî\nbularning barchasi EcoPath mobil ilovasida.",
    energy_title:"EcoPath Energiya & Gaz Paneli",
    energy_subtitle:"Shaharlar bo‚Äòyicha energiya sarfini solishtirib, barqaror siyosatni yo‚Äònaltiring.",
    chart_title:"Energiya sharhi",
    total_energy:"Umumiy energiya",
    avg_usage:"O‚Äòrtacha sarf",
    top_district:"Eng yuqori tuman",
    electricity_chart:"Elektr sarfi (kWh)",
    gas_chart:"Gaz sarfi (m¬≥)",
    compare_chart:"Energiya va Gaz taqqoslash (shaharlar)",
    nation_map:"üåç Respublika bo‚Äòyicha energiya xaritasi",
    electricity:"Elektr",
    gas:"Gaz",
    navigation:"Navigatsiya",
    footer_tagline:"Aqlli chiqindi va energiya tahlili orqali barqaror shaharlar.",
    footer_rights:"¬© 2025 EcoPath ‚Äî Barcha huquqlar himoyalangan",
    back_to_top:"Tepaga qaytish"
  }
};

/******** ‚úÖ LANGUAGE ********/
function setLang(lang){localStorage.setItem("lang",lang);translatePage(lang);}
function translatePage(lang){
  document.querySelectorAll("[data-key]").forEach(el=>{
    const key=el.getAttribute("data-key");
    const t = translations?.[lang]?.[key];
    if (typeof t !== "undefined") el.textContent = t;
  });

  // Special case: chart title has a dynamic city span inside
  const title = document.getElementById("chartTitle");
  if (title && translations?.[lang]?.chart_title) {
    title.innerHTML = `${translations[lang].chart_title} (<span id="energyCityLabel">${document.getElementById("energyCityLabel")?.textContent || 'Seoul'}</span>)`;
  }
}
window.onload=()=>{
  const l=localStorage.getItem("lang")||"en";
  document.getElementById("langSelect").value=l;
  translatePage(l);
};

/******** ‚úÖ THEME ********/
themeSwitch.addEventListener("change",e=>{
  document.documentElement.setAttribute("data-theme",e.target.checked?"dark":"light");
});

/******** ‚úÖ CHARTS ********/
let elecChart, gasChart, lineCompareChart;
const energyCityLabel = document.getElementById("energyCityLabel");

function mock(city){
  const base={Seoul:310,Busan:280,Daegu:260,Daejeon:240,Gyeonggi:320,Gangwon:200,Jeju:230};
  const k=base[city],days=[...Array(30)].map((_,i)=>`Day ${i+1}`);
  const e=days.map(()=>Math.round(k*(0.85+Math.random()*0.3)));
  return {days,e,g:e.map(v=>Math.round(v*0.12))};
}

function drawCharts(days,e,g){
  if(elecChart)elecChart.destroy(); if(gasChart)gasChart.destroy(); if(lineCompareChart)lineCompareChart.destroy();

  elecChart=new Chart(document.getElementById("elecChart"),{type:"bar",data:{labels:days,datasets:[{data:e,backgroundColor:"#00a676"}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
  gasChart=new Chart(document.getElementById("gasChart"),{type:"bar",data:{labels:days,datasets:[{data:g,backgroundColor:"#f79c29"}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
  lineCompareChart=new Chart(document.getElementById("lineCompareChart"),{type:"line",data:{labels:days,datasets:[
    {data:e,label:"Electricity",borderColor:"#00a676",tension:.3},
    {data:g,label:"Gas",borderColor:"#f79c29",tension:.3}
  ]}});
  totalEnergy.textContent=e.reduce((a,b)=>a+b,0)+" kWh";
  avgEnergy.textContent=Math.round(e.reduce((a,b)=>a+b,0)/e.length)+" kWh";
  topEnergyDistrict.textContent=energyCityLabel.textContent;
}

async function loadEnergy(c){
  energyCityLabel.textContent=c;
  chartTitle.textContent=`Energy Overview (${c})`;
  const m=mock(c);
  drawCharts(m.days,m.e,m.g);
}

/******** ‚úÖ MAP ********/
let map=L.map("map").setView([37.5665,126.9780],10);
L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{maxZoom:18}).addTo(map);
let markers=[];

async function parseCSV(t){
  return t.trim().split("\n").slice(1).map(r=>{const p=r.split(",");
    return{district:p[0],lat:+p[1],lon:+p[2],elec:+p[3]||200,gas:+p[4]||30};
  });
}

async function loadCityCSV(c){
  const f=`csv/${c.toLowerCase().replace(" ","")}.csv`;
  const txt=await(await fetch(f)).text();
  const parsed = await parseCSV(txt);
  window.currentCityData = parsed; // ‚úÖ store globally for export
  return parsed;
}

function drawMap(d,mode){
  markers.forEach(m=>map.removeLayer(m));
  markers=[];
  d.forEach(x=>{
    const v=mode==="Electricity"?x.elec:x.gas;
    const r=Math.max(6,Math.sqrt(v)/2);
    const col=mode==="Electricity"?"#00a676":"#f79c29";
    const m=L.circleMarker([x.lat,x.lon],{radius:r,color:col,fillColor:col,fillOpacity:.75})
      .bindPopup(`<b>${x.district}</b><br>${mode}: ${v}`).addTo(map);
    markers.push(m);
  });
  map.setView([d[0].lat,d[0].lon],11);
}

/******** ‚úÖ EVENT LISTENERS ********/
citySelect.addEventListener("change",async e=>{
  const c=e.target.value;
  await loadEnergy(c);
  const data=await loadCityCSV(c);
  const m=document.querySelector("input[name='energy']:checked").value;
  drawMap(data,m);
});

document.querySelectorAll("input[name='energy']").forEach(r=>{
  r.addEventListener("change",async()=>{
    const c=citySelect.value;
    const d=await loadCityCSV(c);
    drawMap(d,r.value);
  });
});

/******** ‚úÖ INIT ********/
(async()=>{
  await loadEnergy("Seoul");
  const d=await loadCityCSV("Seoul");
  drawMap(d,"Electricity");
})();

/******** ‚úÖ EXPORT BUTTONS (REAL DATA) ********/
window.currentCityData = []; // backend or CSV data stored here

document.getElementById("downloadCSV").addEventListener("click", () => {
  const data = window.currentCityData;
  if (!data || data.length === 0) {
    alert("No data loaded yet. Please wait for dashboard to finish loading.");
    return;
  }

  const csvHeader = Object.keys(data[0]).join(",");
  const csvRows = data.map(row => Object.values(row).join(","));
  const csvString = [csvHeader, ...csvRows].join("\n");

  const blob = new Blob([csvString], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `EcoPath_${energyCityLabel.textContent}.csv`;
  link.click();
});

document.getElementById("downloadXLSX").addEventListener("click", () => {
  const data = window.currentCityData;
  if (!data || data.length === 0) {
    alert("No data loaded yet. Please wait for dashboard to finish loading.");
    return;
  }

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, energyCityLabel.textContent);
  XLSX.writeFile(wb, `EcoPath_${energyCityLabel.textContent}.xlsx`);
});

</script>
</body>
</html>
